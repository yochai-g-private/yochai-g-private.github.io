<!DOCTYPE html>
<html>
<head> 
	<title> 
		מזג האוויר במושב כרמל 
	</title> 
</head> 

<body style="height: 100%">
	<style>
	
    body {
      background-image: url('LOGO.png');
	  opacity: 1;
      background-size: 130% 80%;
      background-position: top center;
     background-repeat: no-repeat;
 	  background-attachment: fixed;
      background-color: #ffffff; /*#000000;*/ /*#f0f0f0;*/
    }
	</style>
	<div style = "text-align:center;">
		<h1 style="font-size:192px;margin-bottom: 0; opacity: 1">כרמל</h1>
		<h2 id="RESOLUTION" style="font-size:128px; height:128px; margin-top: 0;margin-bottom: 0"  onmouseover="help_RESOLUTION()"></h2>
		<br>
		<div id="UPDATED_AT" style="font-size:48px;margin-top: 0; " onmouseover="help_UPDATED_AT()">wait</div>

		<br>
		<br>
		<br>
		
		<img src="temperature.png" alt="Temperature" width="200" height="200">
		<div id="TEMPERATURE" 	style="color:red; font-size:48px; height:48px"><strong>wait</strong></div>
		<div id="T_RANGE"	  	style="color:red; font-size:32px; height:32px"></div>
		
		<div style="font-size:32px;"><p></p></div>
		<br>
		
		<img src="humidity.png" alt="Humidity" width="200" height="200">
		<div id="HUMIDITY" 		style="color:blue; font-size:48px; height:48px"><strong>wait</strong></div> 
		<div id="H_RANGE"	  	style="color:blue; font-size:32px; height:32px"></div>
		
		<div style="font-size:32px;"><p></p></div>
		<br>
		
		<img src="wind.png" alt="Wind" width="200" height="200">
		<div id="WIND" 			style="color:gray; font-size:48px; height:48px"><strong>wait</strong></div>
		<div id="W_RANGE"	  	style="color:gray; font-size:32px; height:32px"></div>

		<br><br>
		<br><br>
		

		<center>
			<div style="center">
			  <button id="B_WEEKLY" 	onclick="onWeekly()" 		style="margin:15px;"><font size="120">שבועי</font></button>
			  <button id="B_DAILY" 		onclick="onDaily()"  		style="margin:15px;"><font size="120">יומי</font></button>
			  <button id="B_HOURLY" 	onclick="onHourly()" 		style="margin:15px;"><font size="120">שעתי</font></button>
			  <button id="B_MINUTELY" 	onclick="onMinutely()" 	style="margin:15px;"><font size="120">עכשיו</font></button>
			</div>
		</center>

<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script>

  var database;

  const up_arrow   = "\u2191";
  const dn_arrow   = "\u2193";
  const no_arrow   = " ";

  const ResolutionID = { 
	MINUTELY: 'Minutely', 
	HOURLY	: 'Hourly',
	DAILY	: 'Daily',
	WEEKLY 	: 'Weekly' };
	
  let resolution_id = ResolutionID.MINUTELY;
  intervalId = 0;
  
  function get_trend_char(trend_text, idx)  {
    if(trend_text != null && trend_text != "")
    {
      c = trend_text[idx];
      if(c == 'U')  return up_arrow;
      if(c == 'D')  return dn_arrow;
    }

    return no_arrow;
  }

  function no_data() {
    document.getElementById('UPDATED_AT').textContent = "NO DATA";
    document.getElementById('TEMPERATURE').textContent 	= ""; 
    document.getElementById('T_RANGE').textContent 		= ""; 
    document.getElementById('HUMIDITY').textContent    	= "";
    document.getElementById('H_RANGE').textContent 		= ""; 
    document.getElementById('WIND').textContent        	= "";
    document.getElementById('W_RANGE').textContent 		= ""; 
  }

  function updateMinutely(values_arr, trend_text)
  {
	document.getElementById('TEMPERATURE').textContent = values_arr[0] + get_trend_char(trend_text, 0); 
	document.getElementById('T_RANGE').textContent     = "";
	document.getElementById('HUMIDITY').textContent    = values_arr[1] + get_trend_char(trend_text, 1);
	document.getElementById('H_RANGE').textContent     = "";
	document.getElementById('WIND').textContent        = values_arr[2] + get_trend_char(trend_text, 2);
	document.getElementById('W_RANGE').textContent     = values_arr[3].toString() + " .. " + values_arr[4].toString();
  }
  
  function updateHDW(values_arr, trend_text)
  {
	document.getElementById('TEMPERATURE').textContent = values_arr[0] + get_trend_char(trend_text, 0); 
	document.getElementById('T_RANGE').textContent     = values_arr[1].toString() + " .. " + values_arr[2].toString();
	document.getElementById('HUMIDITY').textContent    = values_arr[3] + get_trend_char(trend_text, 1);
	document.getElementById('H_RANGE').textContent     = values_arr[4].toString() + " .. " + values_arr[5].toString();
	document.getElementById('WIND').textContent        = values_arr[6] + get_trend_char(trend_text, 2);
	document.getElementById('W_RANGE').textContent     = values_arr[7].toString() + " .. " + values_arr[8].toString();
  }
  
  function update() {
	resolution = "Carmel/Data/" + resolution_id;
	
    database.ref(resolution).once('value', function(snapshot) {
        if (!snapshot.exists()) 
        {
          no_data();
          return;
        }

        val = snapshot.val();
        timestamp_text = val.timestamp;

        if(timestamp_text == null || timestamp_text == "")
        {
          no_data();
          return;
        }

        last_update = Number(timestamp_text);
        var date = new Date(last_update);

        const year = date.getFullYear();
        const month = date.getMonth() + 1; // Months are zero-based
        const day = date.getDate();
        const hours = date.getHours();
        const minutes = date.getMinutes();
        const seconds = date.getSeconds();

        // Create a formatted string
        const localDateTimeString = `${day}-${month < 10 ? '0' : ''}${month}-${year} ${hours < 10 ? '0' : ''}${hours}:${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

        document.getElementById('UPDATED_AT').textContent = localDateTimeString;

        values_text    = val.values;
        trend_text     = val.trend;

        values_arr  = values_text.split(";");

		switch(resolution_id)
		{
			case ResolutionID.MINUTELY: updateMinutely(values_arr, trend_text); 	break;
			default: 					updateHDW     (values_arr, trend_text); 	break;
		}
      });
  }

  function onWeekly()	{
	clearInterval(intervalId);
	resolution_id = ResolutionID.WEEKLY;
	
	document.getElementById('RESOLUTION').textContent 	= "שבועי";
	document.getElementById('B_WEEKLY').hidden 			= true;
	document.getElementById('B_DAILY').hidden 			= false;
	document.getElementById('B_HOURLY').hidden 			= false;
	document.getElementById('B_MINUTELY').hidden 		= false;
	
	update();
	intervalId = setInterval(update, 10000);
  }
  
  function onDaily()	{
	clearInterval(intervalId);
	resolution_id = ResolutionID.DAILY;
	
	document.getElementById('RESOLUTION').textContent 	= "יומי";
	document.getElementById('B_WEEKLY').hidden 			= false;
	document.getElementById('B_DAILY').hidden 			= true;
	document.getElementById('B_HOURLY').hidden 			= false;
	document.getElementById('B_MINUTELY').hidden 		= false;
	
	update();
	intervalId = setInterval(update, 10000);
  }
  
  function onHourly()	{
	clearInterval(intervalId);
	resolution_id = ResolutionID.HOURLY;
	
	document.getElementById('RESOLUTION').textContent = "שעתי";
	document.getElementById('B_WEEKLY').hidden 		= false;
	document.getElementById('B_DAILY').hidden 		= false;
	document.getElementById('B_HOURLY').hidden 		= true;
	document.getElementById('B_MINUTELY').hidden 	= false;
	
	update();
	intervalId = setInterval(update, 10000);
  }
  
  function onMinutely()	{
	clearInterval(intervalId);
	resolution_id = ResolutionID.MINUTELY;
	
	document.getElementById('RESOLUTION').textContent = "עכשיו";
	document.getElementById('B_WEEKLY').hidden 		= false;
	document.getElementById('B_DAILY').hidden 		= false;
	document.getElementById('B_HOURLY').hidden 		= false;
	document.getElementById('B_MINUTELY').hidden 	= true;
	
	update();
	intervalId = setInterval(update, 10000);
  }
  
  function initialize() {
  // Initialize Firebase with your configuration
    var firebaseConfig = {
      apiKey: "AIzaSyA_Uje9DJhLGwoIfBqepiInDCdyvuJS_Yo",
      authDomain: "",
      databaseURL: "https://weather-42f34-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "carmel-weather",
      storageBucket: "",
      messagingSenderId: "",
      appId: ""
    };

    firebase.initializeApp(firebaseConfig);
    database = firebase.database();

	onMinutely();
  }

  initialize();

  function help_RESOLUTION()	{
	text = "?";
	switch(resolution_id)
	{
		case ResolutionID.MINUTELY: text = "ממוצע הדקה האחרונה"; 		break;
		case ResolutionID.HOURLY: 	text = "ממוצע 60 הדקות האחרונות"; 	break;
		case ResolutionID.DAILY: 	text = "ממוצע 24 השעות האחרונות"; 	break;
		case ResolutionID.WEEKLY: 	text = "ממוצע 7 היממות האחרונות"; 	break;
	}
	
	alert(text);
  }
  
  function help_UPDATED_AT()	{
	alert("מועד העדכון האחרון");
	}
</script>
</div>
</body>
</html>
